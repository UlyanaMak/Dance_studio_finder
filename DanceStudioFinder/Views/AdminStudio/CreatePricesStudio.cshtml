@model DanceStudioFinder.ViewModels.CreatePricesStudioViewModel 
@{
    ViewData["Title"] = "Добавление цен студии";
}
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Поиск танцевальных студий</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/adminStudio.css" asp-append-version="true" />
</head>

@section AdminInfo {
    @($"Администратор: {Model.Admin.Name} {Model.Admin.Surname}")
    <button type="button" id="deleteAdmin" class="main-button">
        Удалить администратора
    </button>
}
@section HeaderButtons { 
    <!--Кнопка сохранения, нажимает сохранение в форме-->
    <button type="button" id="buttonToSaveChanges" class="main-button"> 
        Далее
    </button>
    <!--Выход на главную страницу-->
    <input class="main-button" type="submit" onclick="location.href ='@Url.Action("Index", "Home")'" value="Выйти" />
}
<body>
    <form class="needs-validation" novalidate asp-controller="AdminStudio" asp-action="CreatePricesStudio" method="post">
        <input type="hidden" asp-for="Admin.IdAdmin" />  <!--Скрытое поле для сохраненя id админа-->
        <input type="hidden" asp-for="DanceStudio.IdStudio"/>  <!--Скрытое поле для сохраненя инофрмации о студии-->
        <input type="hidden" id="groupsData" name="GroupsData" />
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        <div class="container-fluid px-3">

            <!--Заполнение (и добавление) цен-->
            <span class="field-title">Цены</span>
            <div id="price-container" class="mb-3">
                <!-- Первое обязательное поле (без кнопки удаления) -->
                <div class="row g-2 align-items-center mb-2 price-row" id="priceRow0">
                    <div class="col-4">
                        <div class="form-floating mb-3 validation">
                            <input asp-for="Prices[0].Price1" type="text" style="border: 1px solid #F7C9D4;" class="form-control price-input" placeholder="Цена">
                            <label>Цена</label>
                            <span asp-validation-for="Prices[0].Price1" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-floating mb-3 validation">
                            <input asp-for="Prices[0].Description" type="text" style="border: 1px solid #F7C9D4;" class="form-control description-input" placeholder="Описание">
                            <label>Описание</label>
                            <span asp-validation-for="Prices[0].Description" class="text-danger"></span>
                        </div>
                    </div>
                    <!-- Нет кнопки удаления для первого поля -->
                </div>
            </div>

            <!-- Кнопка добавления новых полей -->
            <button type="button" class="btn btn-outline-primary" onclick="addPriceField()">+ Добавить цену</button>
            <input type="hidden" id="pricesData" name="PricesData" />
        </div>
        <!--Невидимая кнопка для активации валидации данных-->
        <button type="submit" id="saveChanges" class="main-button" style="display: none;">Сохранить</button>
    </form>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.js"></script>

</body>
@section Scripts {
    <script>
        document.getElementById('buttonToSaveChanges').addEventListener('click', function () {
            document.getElementById('saveChanges').click();
        });

        let priceIndex = 1; // Начинаем с 1, так как 0 уже есть

        function addPriceField() {
            const container = document.getElementById("price-container");

            const row = document.createElement("div");
            row.className = "row g-2 align-items-center mb-2 price-row";
            row.id = `priceRow${priceIndex}`;

            row.innerHTML = `
                <div class="col-4">
                    <div class="form-floating mb-3 validation">
                        <input name="Prices[${priceIndex}].Price1" type="text"
                               style="border: 1px solid #F7C9D4;"
                               class="form-control price-input" placeholder="Цена">
                        <label>Цена</label>
                        <span class="text-danger field-validation-valid"
                              data-valmsg-for="Prices[${priceIndex}].Price1"
                              data-valmsg-replace="true"></span>
                    </div>
                </div>
                <div class="col-6">
                    <div class="form-floating mb-3 validation">
                        <input name="Prices[${priceIndex}].Description" type="text"
                               style="border: 1px solid #F7C9D4;"
                               class="form-control description-input" placeholder="Описание">
                        <label>Описание</label>
                        <span class="text-danger field-validation-valid"
                              data-valmsg-for="Prices[${priceIndex}].Description"
                              data-valmsg-replace="true"></span>
                    </div>
                </div>
                <div class="col-2">
                    <button type="button" class="btn btn-outline-danger"
                            onclick="removePriceField('priceRow${priceIndex}')">
                        Удалить
                    </button>
                </div>
            `;

            container.appendChild(row);

            // Переинициализация валидации для всей формы
            const form = $("form");
            form.removeData("validator");
            form.removeData("unobtrusiveValidation");
            $.validator.unobtrusive.parse(form);

            priceIndex++;
        }

        function removePriceField(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                // Переиндексация не требуется, так как мы используем Prices[index]
            }
        }

        document.querySelector('form').addEventListener('submit', function (event) {
            // Проверяем валидность формы
            const form = $(this);
            if (!form.valid()) {
                event.preventDefault();
                return false;
            }

            // Собираем все цены (включая первое обязательное поле)
            const priceRows = document.querySelectorAll('#price-container .price-row');
            const prices = [];

            priceRows.forEach((row, index) => {
                const priceInput = row.querySelector('.price-input');
                const descInput = row.querySelector('.description-input');

                if (priceInput && descInput) {
                    prices.push({
                        Price1: priceInput.value,
                        Description: descInput.value
                    });
                }
            });

            // Отправляем данные на сервер
            document.getElementById('pricesData').value = JSON.stringify(prices);

            return true;
        });
    </script>
}
